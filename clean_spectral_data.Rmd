---
title: "Clean spectral data"
author: "Victoria Scholl"
date: "5/19/2020 Earth Lab GRA"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(dplyr)
library(ggplot2)
library(stringr)
library(tidyr)
library(kableExtra)
```

### Explore data

Read original spectra, extracted using NEON data, by mbjoseph: https://gist.github.com/mbjoseph/5c18781e508460e14f64193571b98b7d 

Columns: 

* **individualID** - unique identifier for each individual plant. Individuals can have multiple measurements over time.
* **date.x** - date of plant measurement/observation
* **uid.x** - unique identifier for the record
* **namedLocation** - name of measurement location in NEON database
* **adjEasting, adjNorthing** - UTM coordinates of mapped stem

<p style="color:red">add UTM zone?</p>

* **plantStatus** - physical status of the individual
* **taxonID** - species code
* **scientificName** - scientific name, associated with taxonID, lowest taxonomic rank that can be determined.
* **band_idx** - number of the spectral band (band1, band 2, ... band 426)
* **wavelength_nm** - band wavelength in units of nm
* **reflectance** - decimal reflectance [0,1] extracted from NEON NIS hyperspectral imagery collected during same year
* **mask** - TRUE/LFALSE to identify water absorption bands


```{r}
all_spectra <- read.csv(here::here("data","all_spectra.csv"))
```

Number of unique **individualID** & **uid.x** values: 

```{r, message=TRUE}
length(unique(all_spectra$individualID))

length(unique(all_spectra$uid.x))
```

Number of unique **scientificName** & **taxonID** values (these should match):

```{r}
length(unique(all_spectra$taxonID))

length(unique(all_spectra$scientificName))
```

How many taxonomic identifications are at the genus vs species level? 

<p style="color:red">keep the original genus/species taxon rank column recorded by NEON?</p>


```{r}
# add new column, taxonRank, based on NEON taxonomic data: https://data.neonscience.org/apps/taxon 
# if scientificName contains "sp." , rank is "genus", otherwise "species". 
all_spectra <- all_spectra %>% 
  dplyr::mutate(taxonRank = case_when(
    stringr::str_detect(scientificName, "sp.") ~ "genus",
    TRUE ~ "species"
  ))

# count the number of genus vs species spectra
all_spectra %>% 
  dplyr::distinct(uid.x, .keep_all=TRUE) %>%
  dplyr::group_by(taxonRank) %>% 
  dplyr::tally() %>% 
  kableExtra::kable() %>%
  kableExtra::kable_styling(bootstrap_options = "striped", 
                            full_width = F, 
                            position = "left")

# count the number of spectra per species (unique identifiers)
species_count <- all_spectra %>% 
  dplyr::distinct(uid.x, .keep_all=TRUE) %>%
  dplyr::group_by(scientificName) %>% 
  dplyr::tally()


# some scientificName entries have same genus and species, 
# but may/may not have variation
kableExtra::kable(head(species_count, n = 10)) %>%
  kableExtra::kable_styling(bootstrap_options = "striped", 
                            full_width = F, 
                            position = "left")
```

There are 3 species with variations in the data set (identified manually for now): 

* *Acer saccharum Marshall*, *Acer saccharum Marshall var. saccharum*
* *Cercis canadensis L.*, *Cercis canadensis L. var. canadensis*
* *Pseudotsuga menziesii*, *Pseudotsuga menziesii (Mirb.) Franco var. menziesii*

<p style="color:red">merge spectra species with its variations - give them the same taxonID label? </p>


```{r, warning=FALSE, message=FALSE}
# are there are any species classes that should be merged 
species_var <- all_spectra %>% 
  # first, duplicate the scientificName
  dplyr::mutate(scientificNameTemp = scientificName) %>% 
  # separate into genus and species using space as delimeter 
  tidyr::separate(scientificNameTemp, c("genus", "speciesTemp"), " ", extra = "merge") %>% 
  # separate into species and variation, if present
  tidyr::separate(speciesTemp, c("species", "variation"), "var.", extra = "merge") %>% 
  # select certain columns to assess
  dplyr::select(c(scientificName, genus, species, variation)) %>% 
  dplyr::distinct(scientificName, .keep_all=TRUE) %>% 
  # alphabetical order
  dplyr::arrange(scientificName) 
  
# show the number of spectra with species with multiple variations
species_count %>% 
  dplyr::filter(stringr::str_detect(scientificName, "Acer saccharum Marshall") | 
                stringr::str_detect(scientificName, "Cercis canadensis L.") | 
                stringr::str_detect(scientificName, "Pseudotsuga menziesii")) %>% 
  kableExtra::kable() %>%
  kableExtra::kable_styling(bootstrap_options = "striped", 
                            full_width = F, 
                            position = "left")

```

### Visualize spectra 

Based on Max's Gist code: https://gist.github.com/mbjoseph/5c18781e508460e14f64193571b98b7d 

Plot all spectra; color the spectra based on genus/species taxonomic level. 

```{r, warning=FALSE, fig.height=16, fig.width=14}
all_spectra %>%
  ggplot(aes(wavelength_nm, ifelse(mask, NA, reflectance), group = uid.x,
             # color each facet plot based on taxonRank
             color = taxonRank)) +
  geom_path(alpha = .2) +
  labs(x = '\n Wavelength (nm)',
       y = 'Reflectance \n',
       color = "Taxon Rank") + 
  facet_wrap(~scientificName
             # wrap long scientific names
             #,labeller = label_wrap_gen()) +
             ,labeller = label_wrap_gen(20)) + 
  scale_color_manual(values = c("#e6550d","#1c9099")) + 
  theme_minimal() + 
  # Adjust the text size and rotation angle 
  theme(text = element_text(size=11),
        axis.text.x = element_text(angle=90, hjust=1),
        axis.title.y = element_text(size = 14),
        axis.title.x = element_text(size = 14),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 14))
```

Since the number of unique **individIDs** is not equal to the number of unique **uid.x**, take a closer look at the multiple spectra associated with a single individualID. 

```{r}

# single individualID associated with 4 spectra 
spectrum <- all_spectra %>% 
  dplyr::filter(individualID == "NEON.PLA.D01.BART.02912") 

# unique uid.x values: 
as.character(unique(spectrum$uid.x))

# unique date values: 
as.character(unique(spectrum$date.x))

# number of unique reflectance values
length(unique(spectrum$reflectance))
```

This individualID is associated with four different uid.x values and four different dates values. 

```{r fig.width=12}
# plot the spectra associated with the same individualID
spectrum %>% 
  ggplot(aes(x = wavelength_nm, y = reflectance, group = uid.x)) +
  geom_line(aes(color = uid.x, linetype = uid.x), 
            alpha = 0.5, size = 1) +
  labs(title = paste("Reflectance spectrum, individualID:", spectrum$individualID)) + 
  theme_bw()
```

<p style="color:red">all four reflectance spectra appear to be identical. it appears that they are each associated with a different date, but if they were truly extracted from 4 different NEON NIS image sets, we would expect the reflectance values to have some variation. How to deal with this? How to count the number of instances where this is occurring? </p>

### Standardize the bands

Look at the starting wavelength ("band1") for each reflectance spectrum: 

```{r}
# how many different starting wavelength values in the data set? 
count_min_wavelengths <- all_spectra %>%
  dplyr::filter(band_idx == "band1") %>% 
  dplyr::group_by(wavelength_nm) %>%
  dplyr::count(wavelength_nm)

kableExtra::kable(count_min_wavelengths) %>%
  kableExtra::kable_styling(bootstrap_options = "striped", 
                            full_width = F, 
                            position = "left")
```


Spectra have different starting wavelengths (i.e. 381, 383, 385nm...) and increase in increments of 5nm. Most of them start at 381nm. 

<p style="color:red">Weird outlier starting at 347nm, let's look into that... </p>

```{r}

```






Interpolate wavelength values to have the same starting/ending/increment values. 

