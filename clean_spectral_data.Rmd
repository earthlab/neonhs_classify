---
title: "Clean spectral data"
author: "Victoria Scholl"
date: "5/21/2020 Earth Lab GRA"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(dplyr)
library(ggplot2)
library(stringr)
library(tidyr)
library(kableExtra)
```

### Explore data

Read original spectra, extracted using NEON data, by mbjoseph: https://gist.github.com/mbjoseph/5c18781e508460e14f64193571b98b7d 

Columns: 

* **individualID** - unique identifier for each individual plant. Individuals can have multiple measurements over time.
* **date.x** - date of plant measurement/observation
* **uid.x** - unique identifier for the record
* **namedLocation** - name of measurement location in NEON database
* **adjEasting, adjNorthing** - UTM coordinates of mapped stem

<p style="color:green">VS-NOTE: add UTM zone?</p>

* **plantStatus** - physical status of the individual
* **taxonID** - species code
* **scientificName** - scientific name, associated with taxonID, lowest taxonomic rank that can be determined.
* **band_idx** - number of the spectral band (band1, band 2, ... band 426)
* **wavelength_nm** - band wavelength in units of nm
* **reflectance** - decimal reflectance [0,1] extracted from NEON NIS hyperspectral imagery collected during same year
* **mask** - TRUE/LFALSE to identify water absorption bands


```{r}
all_spectra <- read.csv(here::here("data","all_spectra.csv"))
```

Number of unique **individualID** & **uid.x** values: 

```{r, message=TRUE}
length(unique(all_spectra$individualID))

length(unique(all_spectra$uid.x))
```

Number of unique **scientificName** & **taxonID** values (these should match):

```{r}
length(unique(all_spectra$taxonID))

length(unique(all_spectra$scientificName))
```

How many taxonomic identifications are at the genus vs species level? 

<p style="color:green">VS-NOTE: keep the original genus/species taxon rank column recorded by NEON?</p>


```{r}
# add new column, taxonRank, based on NEON taxonomic data: https://data.neonscience.org/apps/taxon 
# if scientificName contains "sp." , rank is "genus", otherwise "species". 
all_spectra <- all_spectra %>% 
  dplyr::mutate(taxonRank = case_when(
    stringr::str_detect(scientificName, "sp.") ~ "genus",
    TRUE ~ "species"
  ))

# count the number of genus vs species spectra
all_spectra %>% 
  dplyr::distinct(uid.x, .keep_all=TRUE) %>%
  dplyr::group_by(taxonRank) %>% 
  dplyr::tally() %>% 
  kableExtra::kable() %>%
  kableExtra::kable_styling(bootstrap_options = "striped", 
                            full_width = F, 
                            position = "left")

# count the number of spectra per species (unique identifiers)
species_count <- all_spectra %>% 
  dplyr::distinct(uid.x, .keep_all=TRUE) %>%
  dplyr::group_by(scientificName) %>% 
  dplyr::tally()


# some scientificName entries have same genus and species, 
# but may/may not have variation
kableExtra::kable(head(species_count, n = 10)) %>%
  kableExtra::kable_styling(bootstrap_options = "striped", 
                            full_width = F, 
                            position = "left")
```

There are 3 species with variations in the data set (identified manually for now): 

* *Acer saccharum Marshall*, *Acer saccharum Marshall var. saccharum*
* *Cercis canadensis L.*, *Cercis canadensis L. var. canadensis*
* *Pseudotsuga menziesii*, *Pseudotsuga menziesii (Mirb.) Franco var. menziesii*

<p style="color:green">VS-NOTE: merge spectra species with its variations - give them the same taxonID label? </p>


```{r, warning=FALSE, message=FALSE}
# are there are any species classes that should be merged 
species_var <- all_spectra %>% 
  # first, duplicate the scientificName
  dplyr::mutate(scientificNameTemp = scientificName) %>% 
  # separate into genus and species using space as delimeter 
  tidyr::separate(scientificNameTemp, c("genus", "speciesTemp"), " ", extra = "merge") %>% 
  # separate into species and variation, if present
  tidyr::separate(speciesTemp, c("species", "variation"), "var.", extra = "merge") %>% 
  # select certain columns to assess
  dplyr::select(c(scientificName, genus, species, variation)) %>% 
  dplyr::distinct(scientificName, .keep_all=TRUE) %>% 
  # alphabetical order
  dplyr::arrange(scientificName) 
  
# show the number of spectra with species with multiple variations
species_count %>% 
  dplyr::filter(stringr::str_detect(scientificName, "Acer saccharum Marshall") | 
                stringr::str_detect(scientificName, "Cercis canadensis L.") | 
                stringr::str_detect(scientificName, "Pseudotsuga menziesii")) %>% 
  kableExtra::kable() %>%
  kableExtra::kable_styling(bootstrap_options = "striped", 
                            full_width = F, 
                            position = "left")

```

### Visualize spectra 

Based on Max's Gist code: https://gist.github.com/mbjoseph/5c18781e508460e14f64193571b98b7d 

Plot all spectra; color the spectra based on genus/species taxonomic level. 

```{r, warning=FALSE, fig.height=16, fig.width=14}
all_spectra %>%
  ggplot(aes(wavelength_nm, ifelse(mask, NA, reflectance), group = uid.x,
             # color each facet plot based on taxonRank
             color = taxonRank)) +
  geom_path(alpha = .2) +
  labs(x = '\n Wavelength (nm)',
       y = 'Reflectance \n',
       color = "Taxon Rank") + 
  facet_wrap(~scientificName
             # wrap long scientific names
             ,labeller = label_wrap_gen(20)) + 
  scale_color_manual(values = c("#e6550d","#1c9099")) + 
  theme_minimal() + 
  # Adjust the text size and rotation angle 
  theme(text = element_text(size=11),
        axis.text.x = element_text(angle=90, hjust=1),
        axis.title.y = element_text(size = 14),
        axis.title.x = element_text(size = 14),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 14))
```

Since the number of unique **individIDs** is not equal to the number of unique **uid.x**, take a closer look at the multiple spectra associated with a single individualID. 

```{r}
# single individualID associated with 4 spectra 
spectrum <- all_spectra %>% 
  dplyr::filter(individualID == "NEON.PLA.D01.BART.02912") 

# unique uid.x values: 
as.character(unique(spectrum$uid.x))

# unique date values: 
as.character(unique(spectrum$date.x))

# number of unique reflectance values
length(unique(spectrum$reflectance))
```

This individualID is associated with four different uid.x values and four different dates values. 

```{r fig.width=12}
# plot the spectra associated with the same individualID
spectrum %>% 
  ggplot(aes(x = wavelength_nm, y = reflectance, group = uid.x)) +
  geom_line(aes(color = uid.x, linetype = uid.x), 
            alpha = 0.5, size = 1) +
  labs(title = paste("Reflectance spectrum, individualID:", spectrum$individualID)) + 
  theme_bw()
```

<p style="color:green">VS-NOTE: all four reflectance spectra appear to be identical. it appears that they are each associated with a different date, but if they were truly extracted from 4 different NEON NIS image sets, we would expect the reflectance values to have some variation. How to deal with this? How to count the number of instances where this is occurring? </p>

### Explore the bands

Look at the starting wavelength ("band1") for each reflectance spectrum: 

```{r}
# how many different starting wavelength values in the data set? 
count_min_wavelengths <- all_spectra %>%
  dplyr::filter(band_idx == "band1") %>% 
  dplyr::group_by(wavelength_nm) %>%
  dplyr::count(wavelength_nm)

kableExtra::kable(count_min_wavelengths) %>%
  kableExtra::kable_styling(bootstrap_options = "striped", 
                            full_width = F, 
                            position = "left")
```

Spectra have different starting wavelengths (i.e. 381, 383, 385nm...) and increase in increments of 5nm. Most of them start at 381nm. 

```{r}
# find an individualID that starts with each of these wavelength band1 values
as.character(all_spectra$individualID[all_spectra$wavelength_nm == 347][1])
# 381 --> "NEON.PLA.D16.ABBY.01037"
# 382 --> "NEON.PLA.D16.ABBY.01515"
# 384 --> "NEON.PLA.D01.BART.02912"
# 347 --> "NEON.PLA.D20.PUUM.08313"   weird? 
```


```{r warning=FALSE, fig.width=12}
# plot all 4 spectra to see their starting/ending wavelengths
all_spectra %>% 
  dplyr::filter(individualID %in% c("NEON.PLA.D20.PUUM.08313", 
                                    "NEON.PLA.D16.ABBY.01037",
                                    "NEON.PLA.D16.ABBY.01515",
                                    "NEON.PLA.D01.BART.02912")) %>%
  ggplot(aes(x = wavelength_nm, y = reflectance, group = individualID)) +
  geom_line(aes(color = individualID), 
            alpha = 0.4) +
  labs(title = "Four reflectance spectra, each with different starting wavelength") + 
  theme_bw()
```

<p style="color:green">VS-NOTE: Weird outlier starting at 347nm... creating plots to zoom into the beginning/end of the wavelength range</p>

Beginning of wavelength range: 

```{r warning=FALSE, fig.width=12}
# plot all 4 spectra to see their starting/ending wavelengths
all_spectra %>% 
  dplyr::filter(individualID %in% c("NEON.PLA.D20.PUUM.08313", 
                                    "NEON.PLA.D16.ABBY.01037",
                                    "NEON.PLA.D16.ABBY.01515",
                                    "NEON.PLA.D01.BART.02912")) %>%
  ggplot(aes(x = wavelength_nm, y = reflectance, group = individualID)) +
  geom_line(aes(color = individualID), 
            alpha = 0.5, size = 1) +
  labs(title = "Four spectra, each with different wavelengths. Zoom in on beginning of spectra") + 
  # zoom in on beginning of spectra
  lims(x = c(340,400), y = c(0,0.5)) +
  theme_bw()
```

End of wavelength range: 

```{r warning=FALSE, fig.width=12}
# plot all 4 spectra to see their starting/ending wavelengths
all_spectra %>% 
  dplyr::filter(individualID %in% c("NEON.PLA.D20.PUUM.08313", 
                                    "NEON.PLA.D16.ABBY.01037",
                                    "NEON.PLA.D16.ABBY.01515",
                                    "NEON.PLA.D01.BART.02912")) %>%
  ggplot(aes(x = wavelength_nm, y = reflectance, group = individualID)) +
  geom_line(aes(color = individualID), 
            alpha = 0.5, size = 1) +
  labs(title = "Four spectra, each with different wavelengths. Zoom in on end of spectra") + 
  # zoom in on end of spectra
  lims(x = c(2460,2520), y = c(0,0.3)) + 
  theme_bw()
```


### Standardize the bands: Interpolate wavelengths 

Interpolate wavelength values to have the same 426 bands starting at 381nm, ending at 2510nm, incrementing by 5nm. 

```{r, warning=FALSE, message=FALSE}
# get a spectrum starting on 381, the target wavelengths
wl_target <- all_spectra %>% 
  dplyr::filter(individualID == "NEON.PLA.D16.ABBY.01037") %>% 
  dplyr::select(band_idx, wavelength_nm, reflectance)

# get a spectrum starting on 384, with values to be interpolated
wl_orig <- all_spectra %>% 
  dplyr::filter(individualID == "NEON.PLA.D01.BART.02912") %>% 
  dplyr::select(band_idx, wavelength_nm, reflectance)

wl_interp <- approx(x = wl_orig$wavelength_nm,
                    y = wl_orig$reflectance,
                    xout = wl_target$wavelength_nm,
                    method = "linear")

wl_plot <- cbind(wl_orig, wl_target$wavelength_nm, wl_interp)

# show table of interpolated values 
kableExtra::kable(head(wl_plot, n = 10)) %>%
  kableExtra::kable_styling(bootstrap_options = "striped", 
                            full_width = F, 
                            position = "left")
```


<p style="color:green">VS-NOTE: How to deal with points on the edges? And how to interpolate more efficiently in the tidy long data format...</p>

```{r}
# plot original and interpolated reflectance spectrum
```

### Standardize train, evaluation, & test set

Split multiple observations of individuals across sets. Add a column to the data (“train”, “eval”, “test”).

<p style="color:green">VS-NOTE: what percentage is standard for these? How to split based on the class imbalance?</p>


### Output "clean dataset" 



