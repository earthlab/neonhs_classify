---
title: "Explore spectral variability"
author: "Victoria Scholl"
date: "6/25/2020"
output: html_document
---

```{r setup, warning=FALSE, message=FALSE}
library(dplyr)
library(ggplot2)
library(tidyr)
library(stringr)
```


## Spectral variability for individuals with multiple observations across years.

```{r read_data}
all_spectra <- read.csv(here::here("data","all_spectra.csv"))
```

```{r check_for_multiple_observations}
# see which uid's have multiple observations over time 
count_obs <- all_spectra %>%
  dplyr::group_by(individualID) %>% 
  filter(band_idx == "band1") %>%
  tally() 

table(count_obs$n)
```

Most individualIDs have just one spectrum, while others have two or three in the data set. 

```{r}
all_spectra %>%
  distinct(individualID, spectraID) %>%
  count(individualID) %>%
  arrange(-n) %>% 
  head(n = 10)
```


```{r plot_multiple_obs_per_indvdlID}
current_indvdlID <- "NEON.PLA.D03.JERC.02220"
current_indvdlID <- "NEON.PLA.D03.OSBS.02053"

# list which dates have data for the current individual ID 
all_spectra %>%
  filter(individualID %in% current_indvdlID) %>%
  group_by(spectraID) %>% 
  tally()

# plot multiple spectra
all_spectra %>%
  filter(individualID %in% current_indvdlID) %>% 
  ggplot(aes(wavelength_nm, ifelse(mask, NA, reflectance), group = year,
             color = year)) + 
  facet_wrap(~year) + 
  geom_path() + 
  theme_bw() + 
  theme(legend.position = "none") + 
  labs(x = '\n Wavelength (nm)',
       y = 'Reflectance \n',
       color = "Date",
       title = paste0("Multiple observations for ", current_indvdlID))

# VS-NOTE: 
color by year, facet by individual

```

```{r}
# standard deviation for individuals across multiple years 
all_spectra %>% 
  # filter to keep only individualIDs with 3 
  group_by(individualID, wavelength_nm) %>%
  summarize(sd = sd(reflectance))
  
# using aggregate method 
sd_spectra <- aggregate(all_spectra$reflectance, by=list(all_spectra$individualID, all_spectra$wavelength_nm), 
          FUN=sd)
```


<span style="color:red">To do: 

* standard deviation within species
* facet by species, scatter plot x - wavelength, y - standard deviation
* Patterns of variation across species? 

</span>, 


# VS-NOTE: standard deviation within species
# Facet by species, scatter plot x - wavelength, y - standard deviation
# Patterns of variation across species? 


## Spectra with 347nm starting wavelength

```{r}
spectraIDs_347nm <- all_spectra %>%
  dplyr::filter(band_idx == "band1") %>% 
  dplyr::filter(wavelength_nm == 347) %>% 
  dplyr::select(spectraID)

# split the spectraID strings to see which site is causing the 347nm starting wavelength
spectraIDs_347nm$neon_site <- stringr::str_split(as.character(spectraIDs_347nm$spectraID),
                   pattern = "[.]")[[1]][4]

print(unique(spectraIDs_347nm$neon_site))
```

They are all from the PUUM site, Pu'u Maka'ala Natural Area Reserve: https://www.neonscience.org/field-sites/field-sites-map/PUUM
