---
title: "Classify veg"
author: "Victoria Scholl"
date: "07/16/2020 Earth Lab GRA"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(tidyr)
library(dplyr)
library(randomForest)
library(caret)
library(ranger)
```

## Classify species

```{r}
# read the cleaned data, labeled for train, test, 
cleaned_data <- read_csv(here::here("data","cleaned_spectra.csv"))

# columns to keep for training the classifier
cols_to_keep <- c("spectraID", "band_idx", "reflectance", "taxonID")

# grab the training data 
train_data <- cleaned_data %>% 
  dplyr::filter(group == "train") %>% 
  # use the mask to remove bad bands
  #dplyr::filter(mask == FALSE) %>%
  # remove all entries with NA reflectance values, indicative of bad bands
  dplyr::filter(!is.na(reflectance)) %>% 
  # keep only the columns needed for classification
  dplyr::select(all_of(cols_to_keep)) %>%
  # reshape the data from long to wide so each row is a spectrum, 
    # and each col contains reflectance per band.
  tidyr::pivot_wider(names_from = band_idx, 
                     values_from = reflectance) %>% 
  # remove spectraID since it's not a descriptive feature 
  dplyr::select(-spectraID) 

# convert taxonID to factor, so R does classification instead of regression.
# reassign the factor levels after subsetting the training data
train_data$taxonID <- factor(train_data$taxonID)

  # need to filter out all spectra at the genus/variation level? 
  # I wonder if i should make a new col with genus + species, since 
  # taxonID can be more specific for variations? 

```

```{r randomForest}
# train random forest classifiers: predict taxonID
rf_classifier = randomForest::randomForest(taxonID ~ ., 
                                           data=train_data, 
                                           #ntree=100, 
                                           #mtry=12, 
                                           importance=TRUE,
                                           na.action = na.omit)

# Got this error when trying to train: 
# Error in randomForest.default(m, y, ...) : Can't have empty classes in y.
# But all taxonID values appear to have at least one value
table(train_data$taxonID)

# no NAs in the taxonID column
sum(is.na(train_data$taxonID))
```

```{r caret}
rf_fit <- caret::train(as.factor(taxonID) ~ ., 
                data = train_data, 
                method = "ranger") # specify "ranger" method to implement RF 
# Error in na.fail.default(list(`as.factor(taxonID)` = c(51L, 51L, 51L, : missing values in object
```

